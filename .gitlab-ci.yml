image: rocker/tidyverse

stages:
  - check
  - test

variables:
  _R_CHECK_CRAN_INCOMING_: "false"
  _R_CHECK_SUGGESTS_ONLY: "false"
  _R_CHECK_FORCE_SUGGESTS_: "true"
  CODECOV_TOKEN: "CODECOV_TOKEN_STRING"
  APT_PKGS: "libgeos-dev"
  APT_CACHE: "apt-cache"
  CRAN_MIRROR: "https://cloud.r-project.org"
  R_LIBS_USER: "$CI_PROJECT_DIR/ci/lib"
  R_LIBS: "$CI_PROJECT_DIR/ci/lib"
  CHECK_DIR: "$CI_PROJECT_DIR/ci/logs"


getready:
  stage: .pre
  script:
    - mkdir -p $R_LIBS_USER $BUILD_LOGS_DIR $APT_CACHE
    - apt-get update
    - apt-get -o dir::cache::archives="apt-cache" install -y --no-install-recommends ${APT_PKGS}
    - R -e 'install.packages(c("lintr","ggthemes", "sp", "mapproj", "maps", "maptools", "rgeos", "shinycssloaders", "shinydashboard"), repos = Sys.getenv("CRAN_MIRROR"), lib = Sys.getenv("R_LIBS_USER"))'
    - R -e 'withr::with_libpaths(new = Sys.getenv("R_LIBS_USER"), remotes::install_github("USGS-R/wateRuse",  repos = Sys.getenv("CRAN_MIRROR")))'
  cache:
    paths:
     - $R_LIBS_USER
     - $APT_CACHE
  artifacts:
    paths:
     - $R_LIBS_USER
     - $APT_CACHE

buildcheck:
  stage: check
  script:
    - apt-get -o dir::cache::archives=${APT_CACHE} install -y --no-install-recommends ${APT_PKGS}
    - apt-get -o dir::cache::archives=${APT_CACHE} install -y --no-install-recommends qpdf pandoc pandoc-citeproc
    - R CMD build . --no-build-vignettes --no-manual
    - R -e 'devtools::check(document = FALSE, args = "--no-tests", error_on = "error")'
    - R -e 'lintr::lint_package()'
    

unittests:
  stage: test
  script:
    - apt-get -o dir::cache::archives=${APT_CACHE} install -y --no-install-recommends ${APT_PKGS}
    - R -e '.libPaths()'
    - R -e 'if (any(as.data.frame(devtools::test())[["failed"]] > 0)) stop("Some tests failed.")'

covertests:
  stage: test
  script:
    - apt-get -o dir::cache::archives=${APT_CACHE} install -y --no-install-recommends ${APT_PKGS}
    - R -e 'x <- covr::package_coverage();x'
    - R -e 'write.table(covr::percent_coverage(x), file = "test.txt", row.names = FALSE, col.names = FALSE)'
  artifacts:
    path: 
      - 'test.txt'

